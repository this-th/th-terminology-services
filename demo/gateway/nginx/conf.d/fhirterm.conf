server {
    js_import main from /etc/nginx/conf.d/rbac.js;
    server_name fhirterm.domain.org;
    listen 443 ssl;

    ssl_certificate /etc/letsencrypt/live/domain.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/domain.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparam.pem;

    client_max_body_size 600m;
    proxy_read_timeout 300m;
    proxy_connect_timeout 300m;
    proxy_send_timeout 300m;

    error_page 401 /custom-401.html;
    location = /custom-401.html {
        root /etc/nginx/html;
        internal;
    }

    location / {
        auth_request /_authz;
        proxy_pass http://192.168.2.4:9080;
        proxy_pass_request_headers on;
    }

    location = /_authz {
        internal;
        js_content main.authz; # function name in rbac.js
    }

    location = /_opa {
        internal;
        proxy_pass http://localhost:8181/v1/data/terminology/fhir;
    }

}

server {
  if ($host = fhirterm.domain.org) {
    return 301 https://$host$request_uri;
  }
  listen 80;
  server_name fhirterm.domain.org;
  return 404;
}
