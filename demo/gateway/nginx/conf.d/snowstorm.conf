server {
    js_import main from /etc/nginx/conf.d/rbac.js;
    server_name snowstorm.domain.org;
    listen 443 ssl;

    ssl_certificate /etc/letsencrypt/live/domain.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/domain.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparam.pem;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    client_max_body_size 600m;
    proxy_read_timeout 30m;
    proxy_connect_timeout 30m;
    proxy_send_timeout 30m;

    error_page 401 /custom-401.html;
    location = /custom-401.html {
        root /etc/nginx/html;
        internal;
    }

    location / {
        auth_request /_authz;
        proxy_pass http://192.168.2.2:8081;
        proxy_pass_request_headers on;
    }

    location = /_authz {
        internal;
        js_content main.authz; # function name in rbac.js
    }

    location = /_opa {
        internal;
        proxy_pass http://localhost:8181/v1/data/terminology/snowstorm;
    }

}

server {
  if ($host = snowstorm.domain.org) {
    return 301 https://$host$request_uri;
  }

  listen 80;
  server_name snowstorm.domain.org;

  return 404;
}
